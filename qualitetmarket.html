<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>QualitetMarket – Zarabianie u Szefa</title>
  <link rel="stylesheet" href="styles.css">

  <!-- planGuard fallback: /js/ oraz root -->
  <script>
    (function () {
      const tryLoad = (src, next) => {
        const s = document.createElement("script");
        s.defer = true;
        s.src = src;
        s.onerror = () => next && next();
        document.head.appendChild(s);
      };
      tryLoad("js/planGuard.js", () => tryLoad("planGuard.js"));
    })();
  </script>
</head>

<body data-require="pro">

<div class="nav" data-nav-root>
  <div class="nav-inner">
    <div class="brand">
      <div class="logo"></div>
      <div class="brand-title">QualitetMarket</div>
      <span id="planBadge" class="plan-badge"></span>
    </div>

    <button class="nav-toggle" type="button" aria-label="Menu" aria-expanded="false" data-nav-toggle>
      <span></span><span></span><span></span>
    </button>

    <div class="nav-links" data-nav-links>
      <a href="index.html">Start</a>
      <a href="cennik.html">Plany</a>
      <a class="active" href="qualitetmarket.html">QualitetMarket</a>
      <a href="intelligence.html" data-elite-link>Intelligence</a>
      <a href="blueprints.html" data-elite-link>Blueprints</a>
      <a href="hurtownie.html" id="hurtownieLink">Hurtownie</a>
      <a href="dashboard.html" data-auth-only>Dashboard</a>

      <div class="nav-links-sep"></div>

      <a class="btn btn-sm btn-primary" href="login.html" data-guest-only>Zaloguj</a>
      <a class="btn btn-sm" href="aktywuj-pro.html" data-guest-only>Aktywuj PRO</a>

      <button class="btn btn-sm btn-danger" type="button" onclick="logout()" data-auth-only>Wyloguj</button>
    </div>
  </div>
</div>

<div class="wrap">

  <div class="hero-card reveal">
    <span class="badge"><span class="dot"></span> Marketplace System</span>
    <div class="h1">QualitetMarket</div>
    <div class="p">
      Centrum pracy nad ofertą: wybór produktów, marża, dostawcy, content i publikacja.
      PRO/ELITE zawiera dostęp do panelu sprzedaży Webkul (SP Seller).
    </div>

    <div class="hr"></div>

    <div class="hero-cta">
      <a class="btn btn-primary" href="intelligence.html" data-elite-btn>Sprawdź produkt (Intelligence)</a>
      <a class="btn" href="hurtownie.html">Wejdź w Hurtownie</a>
      <a class="btn btn-secondary" href="blueprints.html" data-elite-btn>Blueprinty wdrożenia</a>
      <a class="btn" href="cennik.html">Upgrade planu</a>
    </div>
  </div>

  <div class="section">
    <div class="section-title reveal">
      <h2>Moduły QualitetMarket</h2>
      <p>To jest Twoja ścieżka pracy: produkt → wynik → wdrożenie → sprzedaż.</p>
    </div>

    <div class="cards">
      <div class="card reveal d2">
        <h3>Intelligence</h3>
        <p>Scoring, marża, koszty i szybka decyzja: brać czy nie.</p>
        <div class="hr"></div>
        <a class="btn btn-primary" href="intelligence.html" data-elite-btn>Otwórz Intelligence</a>
      </div>

      <div class="card reveal d3">
        <h3>Hurtownie</h3>
        <p>Import CSV, selekcja ofert i dostawców pod marżę.</p>
        <div class="hr"></div>
        <a class="btn btn-secondary" href="hurtownie.html">Otwórz Hurtownie</a>
      </div>

      <div class="card reveal d4">
        <h3>Blueprints</h3>
        <p>Gotowe schematy sprzedażowe, które wdrażasz od ręki.</p>
        <div class="hr"></div>
        <a class="btn" href="blueprints.html" data-elite-btn>Otwórz Blueprints</a>
      </div>
    </div>
  </div>

  <!-- ✅ GLOBAL TOP z Hurtowni -->
  <div class="section">
    <div class="section-title reveal">
      <h2>TOP produkty globalnie (ze wszystkich hurtowni)</h2>
      <p>
        To jest “co brać” z Twoich importów CSV. Jeśli tu jest pusto — wejdź w Hurtownie i wgraj CSV.
      </p>
    </div>

    <div id="qmGlobalToast" class="note" style="display:none;margin-bottom:12px;"></div>

    <div class="card reveal d2">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
        <input class="input" id="qmGlobalSearch" type="text" placeholder="Szukaj w globalnych produktach…" style="max-width:420px;">
        <button class="btn btn-sm" type="button" id="qmGlobalExportCsv">Eksport CSV</button>
        <button class="btn btn-sm btn-secondary" type="button" id="qmGlobalExportJson">Eksport JSON</button>
        <button class="btn btn-sm btn-danger" type="button" id="qmGlobalClearDb">Wyczyść bazę hurtowni</button>
      </div>

      <div id="qmGlobalStats" class="muted" style="margin-bottom:10px;"></div>

      <div class="table-wrap">
        <table class="table" id="qmGlobalTable">
          <thead>
            <tr>
              <th>Produkt</th>
              <th>Hurtownia</th>
              <th>Cena hurtowa</th>
              <th>Cena rynkowa</th>
              <th>Marża %</th>
              <th>Score</th>
              <th data-private-col>Twoja cena</th>
              <th data-private-col>Zysk</th>
              <th>Akcja</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="note" style="margin-top:10px;">
        Wybór per produkt: najlepszy <strong>score</strong>, a przy remisie niższa <strong>cena hurtowa</strong>.
        <span style="color:#94a3b8;">Tryb prywatny: Ctrl+Shift+P • Ustaw marżę: Ctrl+Shift+M</span>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title reveal">
      <h2>Dostęp do panelu Webkul (SP Seller)</h2>
      <p>BASIC nie ma panelu. PRO/ELITE mają — dlatego są droższe.</p>
    </div>

    <div class="grid-2">
      <div class="card reveal d2">
        <h3>Masz BASIC</h3>
        <p class="p">
          Masz podgląd i ograniczone moduły. Jeśli chcesz panel sprzedaży Webkul i pełen workflow —
          przejdź na PRO/ELITE.
        </p>
        <div class="hr"></div>
        <div class="hero-cta" style="margin:0;">
          <a class="btn btn-primary" href="cennik.html">Zobacz plany</a>
          <a class="btn" href="aktywuj-pro.html">Aktywuj PRO (demo)</a>
        </div>
      </div>

      <div class="card reveal d3">
        <h3>Masz PRO / ELITE</h3>
        <p class="p">
          Dostajesz dostęp do panelu Webkul (SP Seller) oraz pełne moduły QualitetMarket.
          W demo widzisz flow i UI — docelowo tu będzie weryfikacja płatności.
        </p>
        <div class="hr"></div>
        <div class="hero-cta" style="margin:0;">
          <a class="btn btn-secondary" href="dashboard.html">Przejdź do Dashboard</a>
          <a class="btn" href="intelligence.html" data-elite-btn>Start: Intelligence</a>
        </div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title reveal">
      <h2>Najbliższy cel</h2>
      <p>Żeby to zarabiało: wybierz 1 produkt i dowieź publikację + ruch.</p>
    </div>

    <div class="cards">
      <div class="card reveal d2">
        <h3>Krok 1: Wybór produktu</h3>
        <p>Wchodzisz do Intelligence i oceniasz opłacalność.</p>
      </div>
      <div class="card reveal d3">
        <h3>Krok 2: Dostawca</h3>
        <p>W Hurtowniach wybierasz dostawcę i warunki.</p>
      </div>
      <div class="card reveal d4">
        <h3>Krok 3: Blueprint</h3>
        <p>Wdrażasz gotowy schemat sprzedaży i publikujesz.</p>
      </div>
    </div>
  </div>

</div>

<div class="footer">© 2026 Zarabianie u Szefa × QualitetMarket</div>

<!-- app.js fallback: assets/ oraz root -->
<script>
  (function () {
    const tryLoad = (src, next) => {
      const s = document.createElement("script");
      s.defer = true;
      s.src = src;
      s.onerror = () => next && next();
      document.body.appendChild(s);
    };
    tryLoad("assets/app.js", () => tryLoad("app.js"));
  })();
</script>

<script>
  function logout() {
    localStorage.setItem("is_logged_in", "false");
    window.location.href = "login.html";
  }

  (function () {
    const logged = localStorage.getItem("is_logged_in") === "true";
    document.querySelectorAll("[data-guest-only]").forEach(el => el.style.display = logged ? "none" : "");
    document.querySelectorAll("[data-auth-only]").forEach(el => el.style.display = logged ? "" : "none");

    const plan = (localStorage.getItem("status") || "BASIC").toUpperCase();
    const safePlan = (plan === "PRO" || plan === "ELITE") ? plan : "BASIC";
    if (safePlan !== "ELITE") {
      document.querySelectorAll("[data-elite-btn], [data-elite-link]").forEach(el => el.style.display = "none");
    }
  })();

  (function () {
    const root = document.querySelector("[data-nav-root]");
    const btn = document.querySelector("[data-nav-toggle]");
    const links = document.querySelector("[data-nav-links]");
    if (!root || !btn || !links) return;

    const close = () => {
      root.classList.remove("nav-open");
      btn.setAttribute("aria-expanded", "false");
    };
    const toggle = () => {
      const open = root.classList.toggle("nav-open");
      btn.setAttribute("aria-expanded", open ? "true" : "false");
    };

    btn.addEventListener("click", toggle);
    links.addEventListener("click", (e) => {
      if (e.target.tagName === "A") close();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") close();
    });
  })();
</script>

<!-- ✅ Global TOP + Private Margin + Send to Intelligence -->
<script>
(() => {
  "use strict";

  const LS_PRODUCTS_BY_SUPPLIER = "qm_products_by_supplier_v1";
  const LS_PRIVATE_MODE = "qm_private_mode_v1";    // "1" / "0"
  const LS_MY_MARGIN_PCT = "qm_my_margin_pct_v1";  // np. "30"
  const LS_INTEL_PREFILL = "qm_intel_prefill_v1";  // prefill dla Intelligence

  const $ = (sel) => document.querySelector(sel);
  const els = {
    toast: () => $("#qmGlobalToast"),
    stats: () => $("#qmGlobalStats"),
    search: () => $("#qmGlobalSearch"),
    tbody: () => document.querySelector("#qmGlobalTable tbody"),
    exportCsv: () => $("#qmGlobalExportCsv"),
    exportJson: () => $("#qmGlobalExportJson"),
    clearDb: () => $("#qmGlobalClearDb"),
    privateHeaders: () => document.querySelectorAll("[data-private-col]"),
  };

  function isPrivateMode() {
    return localStorage.getItem(LS_PRIVATE_MODE) === "1";
  }

  function getMyMarginPct() {
    const raw = localStorage.getItem(LS_MY_MARGIN_PCT);
    const n = Number(raw);
    return Number.isFinite(n) ? n : 30;
  }

  function setMyMarginPct(v) {
    const n = Number(v);
    if (!Number.isFinite(n) || n < 0 || n > 300) return false;
    localStorage.setItem(LS_MY_MARGIN_PCT, String(n));
    return true;
  }

  function showToast(msg, type="info") {
    const box = els.toast();
    if (!box) return;
    box.style.display = "";
    box.textContent = msg;

    box.style.border = "1px solid rgba(148,163,184,.25)";
    box.style.background = "rgba(148,163,184,.08)";
    if (type === "error") {
      box.style.border = "1px solid rgba(239,68,68,.35)";
      box.style.background = "rgba(239,68,68,.10)";
    } else if (type === "success") {
      box.style.border = "1px solid rgba(34,197,94,.30)";
      box.style.background = "rgba(34,197,94,.10)";
    }

    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => box.style.display = "none", 2400);
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function normName(s) {
    return String(s || "")
      .toLowerCase()
      .trim()
      .replace(/\s+/g, " ")
      .replace(/[^\p{L}\p{N} ]/gu, "");
  }

  function formatPLN(n) {
    const x = Number(n);
    if (!Number.isFinite(x)) return "–";
    return x.toFixed(2) + " zł";
  }

  function loadSuppliers() {
    try {
      const raw = localStorage.getItem(LS_PRODUCTS_BY_SUPPLIER);
      const list = raw ? JSON.parse(raw) : [];
      return Array.isArray(list) ? list : [];
    } catch {
      return [];
    }
  }

  function consolidateAll() {
    const suppliers = loadSuppliers();
    const map = new Map();
    let total = 0;

    for (const s of suppliers) {
      const supplierName = s?.supplierName || "Hurtownia";
      const products = Array.isArray(s?.products) ? s.products : [];
      total += products.length;

      for (const p of products) {
        const key = normName(p?.name);
        if (!key) continue;

        const item = {
          name: p.name,
          supplierName,
          wholesale: p.wholesale,
          retail: p.retail,
          marginPct: p.marginPct,
          score: p.score
        };

        const prev = map.get(key);
        if (!prev) {
          map.set(key, item);
          continue;
        }

        const better =
          (Number(item.score) > Number(prev.score)) ||
          (Number(item.score) === Number(prev.score) && Number(item.wholesale) < Number(prev.wholesale));

        if (better) map.set(key, item);
      }
    }

    const unique = Array.from(map.values()).sort((a,b) =>
      (Number(b.score) - Number(a.score)) || (Number(b.marginPct) - Number(a.marginPct))
    );

    return { suppliersCount: suppliers.length, total, unique };
  }

  function calcMySellPrice(wholesale, myMarginPct) {
    const w = Number(wholesale);
    const m = Number(myMarginPct);
    if (!Number.isFinite(w) || w <= 0) return NaN;
    if (!Number.isFinite(m)) return NaN;
    return w * (1 + m/100);
  }

  function calcMyProfit(mySellPrice, wholesale) {
    const s = Number(mySellPrice);
    const w = Number(wholesale);
    if (!Number.isFinite(s) || !Number.isFinite(w)) return NaN;
    return s - w;
  }

  function sendToIntelligence(product) {
    const payload = {
      name: product?.name || "",
      supplierName: product?.supplierName || "",
      wholesale: Number(product?.wholesale),
      retail: Number(product?.retail),
      score: Number(product?.score),
      marginPct: Number(product?.marginPct),
      myMarginPct: getMyMarginPct(),
      ts: new Date().toISOString(),
    };
    localStorage.setItem(LS_INTEL_PREFILL, JSON.stringify(payload));
    window.location.href = "intelligence.html";
  }

  function updatePrivateHeadersVisibility() {
    const on = isPrivateMode();
    els.privateHeaders()?.forEach(th => th.style.display = on ? "" : "none");
  }

  function renderTable(list) {
    const tbody = els.tbody();
    if (!tbody) return;
    tbody.innerHTML = "";

    const privateMode = isPrivateMode();
    const myMargin = getMyMarginPct();

    list.forEach((p, i) => {
      const tr = document.createElement("tr");
      if (i < 10) tr.style.background = "rgba(34,197,94,.08)";

      const mySell = calcMySellPrice(p.wholesale, myMargin);
      const myProfit = calcMyProfit(mySell, p.wholesale);

      tr.innerHTML = `
        <td>${escapeHtml(p.name)}</td>
        <td>${escapeHtml(p.supplierName)}</td>
        <td>${formatPLN(p.wholesale)}</td>
        <td>${formatPLN(p.retail)}</td>
        <td>${Number.isFinite(Number(p.marginPct)) ? Number(p.marginPct).toFixed(2) + "%" : "–"}</td>
        <td><strong>${Number.isFinite(Number(p.score)) ? Number(p.score) : "–"}</strong></td>
        ${privateMode ? `
          <td><strong>${formatPLN(mySell)}</strong></td>
          <td>${formatPLN(myProfit)}</td>
        ` : `
          <td style="display:none;"></td>
          <td style="display:none;"></td>
        `}
        <td>
          <button class="btn btn-sm btn-primary" type="button" data-intel>
            Wyślij do Intelligence
          </button>
        </td>
      `;

      tr.querySelector("[data-intel]")?.addEventListener("click", () => sendToIntelligence(p));
      tbody.appendChild(tr);
    });

    updatePrivateHeadersVisibility();
  }

  function setStats({ suppliersCount, total, unique }) {
    const box = els.stats();
    if (!box) return;

    const privateMode = isPrivateMode();
    const myMargin = getMyMarginPct();

    box.innerHTML = `
      Hurtownie w bazie: <strong>${suppliersCount}</strong> •
      Produkty (łącznie): <strong>${total}</strong> •
      Produkty (unikalne): <strong>${unique.length}</strong>
      <span style="color:#94a3b8;">(TOP 10 podświetlone)</span>
      ${privateMode ? `<span style="margin-left:10px;color:#94a3b8;">Tryb prywatny: <strong>ON</strong> • Twoja marża: <strong>${myMargin}%</strong></span>` : ``}
    `;
  }

  function toCsv(headers, rows) {
    const esc = (v) => {
      const s = String(v ?? "");
      if (/[",\n\r;]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
      return s;
    };
    const sep = ";";
    return [
      headers.map(esc).join(sep),
      ...rows.map((r) => r.map(esc).join(sep))
    ].join("\n");
  }

  function downloadBlob(content, mime, filename) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    setTimeout(() => URL.revokeObjectURL(url), 800);
  }

  function debounce(fn, wait=160) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }

  let GLOBAL = [];

  function refresh() {
    const data = consolidateAll();
    GLOBAL = data.unique;
    setStats(data);
    renderTable(GLOBAL.slice(0, 50));

    if (!data.suppliersCount) {
      showToast("Brak danych z Hurtowni. Wejdź w Hurtownie i wgraj CSV.", "error");
    }
  }

  function applySearch() {
    const q = String(els.search()?.value ?? "").trim().toLowerCase();
    const list = q ? GLOBAL.filter(x => String(x.name).toLowerCase().includes(q)) : GLOBAL;
    renderTable(list.slice(0, 50));
  }

  function togglePrivateMode() {
    const next = isPrivateMode() ? "0" : "1";
    localStorage.setItem(LS_PRIVATE_MODE, next);

    if (next === "1") {
      if (localStorage.getItem(LS_MY_MARGIN_PCT) == null) localStorage.setItem(LS_MY_MARGIN_PCT, "30");
      showToast("Tryb prywatny: ON (Ctrl+Shift+P)", "success");
    } else {
      showToast("Tryb prywatny: OFF (Ctrl+Shift+P)", "success");
    }
    refresh();
  }

  function setMarginFlow() {
    const current = getMyMarginPct();
    const val = prompt("Ustaw Twoją marżę % (np. 30). Liczona od ceny hurtowej:", String(current));
    if (val == null) return;
    if (!setMyMarginPct(val)) return showToast("Błędna marża. Podaj liczbę 0–300.", "error");
    showToast("Zapisano Twoją marżę.", "success");
    refresh();
  }

  function bind() {
    els.search()?.addEventListener("input", debounce(applySearch, 140));

    els.exportCsv()?.addEventListener("click", () => {
      if (!GLOBAL.length) return showToast("Brak danych do eksportu.", "error");

      const privateMode = isPrivateMode();
      const myMargin = getMyMarginPct();

      const headers = privateMode
        ? ["name","supplierName","wholesale","retail","marginPct","score","mySellPrice","myProfit","myMarginPct"]
        : ["name","supplierName","wholesale","retail","marginPct","score"];

      const rows = GLOBAL.map(x => {
        if (!privateMode) {
          return [
            x.name,
            x.supplierName,
            Number.isFinite(Number(x.wholesale)) ? Number(x.wholesale).toFixed(2) : "",
            Number.isFinite(Number(x.retail)) ? Number(x.retail).toFixed(2) : "",
            Number.isFinite(Number(x.marginPct)) ? Number(x.marginPct).toFixed(2) : "",
            x.score
          ];
        }
        const mySell = calcMySellPrice(x.wholesale, myMargin);
        const myProfit = calcMyProfit(mySell, x.wholesale);
        return [
          x.name,
          x.supplierName,
          Number.isFinite(Number(x.wholesale)) ? Number(x.wholesale).toFixed(2) : "",
          Number.isFinite(Number(x.retail)) ? Number(x.retail).toFixed(2) : "",
          Number.isFinite(Number(x.marginPct)) ? Number(x.marginPct).toFixed(2) : "",
          x.score,
          Number.isFinite(mySell) ? mySell.toFixed(2) : "",
          Number.isFinite(myProfit) ? myProfit.toFixed(2) : "",
          myMargin
        ];
      });

      const csv = toCsv(headers, rows);
      downloadBlob(csv, "text/csv;charset=utf-8", privateMode ? "qm-global-top-private.csv" : "qm-global-top.csv");
      showToast("Wyeksportowano CSV.", "success");
    });

    els.exportJson()?.addEventListener("click", () => {
      if (!GLOBAL.length) return showToast("Brak danych do eksportu.", "error");

      const privateMode = isPrivateMode();
      const myMargin = getMyMarginPct();

      const out = privateMode
        ? GLOBAL.map(x => {
            const mySell = calcMySellPrice(x.wholesale, myMargin);
            const myProfit = calcMyProfit(mySell, x.wholesale);
            return { ...x, myMarginPct: myMargin, mySellPrice: mySell, myProfit };
          })
        : GLOBAL;

      downloadBlob(JSON.stringify(out, null, 2), "application/json", privateMode ? "qm-global-top-private.json" : "qm-global-top.json");
      showToast("Wyeksportowano JSON.", "success");
    });

    els.clearDb()?.addEventListener("click", () => {
      localStorage.removeItem(LS_PRODUCTS_BY_SUPPLIER);
      GLOBAL = [];
      renderTable([]);
      setStats({ suppliersCount: 0, total: 0, unique: [] });
      showToast("Wyczyszczono bazę hurtowni (produkty per hurtownia).", "success");
    });

    document.addEventListener("keydown", (e) => {
      if (!e.ctrlKey || !e.shiftKey) return;
      const k = String(e.key || "").toLowerCase();
      if (k === "p") {
        e.preventDefault();
        togglePrivateMode();
      }
      if (k === "m") {
        e.preventDefault();
        setMarginFlow();
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    // domyślnie prywatny OFF + ukryj prywatne nagłówki
    if (localStorage.getItem(LS_PRIVATE_MODE) == null) localStorage.setItem(LS_PRIVATE_MODE, "0");
    updatePrivateHeadersVisibility();

    bind();
    refresh();
  });
})();
</script>

</body>
</html>
