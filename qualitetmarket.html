<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QualitetMarket – Global TOP</title>

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="stylesheet" href="/styles.css">

  <!-- Guard pierwszy -->
  <script defer src="/js/planGuard.js"></script>
  <script defer src="/app.js"></script>
</head>

<body data-require="pro">

<div class="nav" data-nav-root>
  <div class="nav-inner">
    <div class="brand">
      <div class="logo"></div>
      <div class="brand-title">QualitetMarket</div>
      <span id="planBadge" class="plan-badge"></span>
    </div>

    <button class="nav-toggle" type="button" aria-label="Menu" aria-expanded="false" data-nav-toggle>
      <span></span><span></span><span></span>
    </button>

    <div class="nav-links" data-nav-links>
      <a href="/index.html">Start</a>
      <a href="/cennik.html">Plany</a>
      <a class="active" href="/qualitetmarket.html">QualitetMarket</a>
      <a href="/intelligence.html">Intelligence</a>
      <a href="/listing.html">Listing</a>
      <a href="/blueprints.html">Blueprints</a>
      <a href="/hurtownie.html" id="hurtownieLink">Hurtownie</a>
      <a href="/dashboard.html" data-auth-only>Dashboard</a>

      <div class="nav-links-sep"></div>

      <a class="btn btn-sm btn-primary" href="/login.html" data-guest-only>Zaloguj</a>
      <a class="btn btn-sm" href="/aktywuj-pro.html" data-guest-only>Aktywuj PRO</a>

      <button class="btn btn-sm btn-danger" type="button" onclick="logout()" data-auth-only>Wyloguj</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="hero-card reveal">
    <span class="badge"><span class="dot"></span> QualitetMarket • Global TOP</span>
    <div class="h1">Global TOP</div>
    <div class="p">Ranking produktów z hurtowni (localStorage) + 1 klik do Intelligence / Listing.</div>

    <div class="hr"></div>

    <div class="hero-cta">
      <a class="btn btn-secondary" href="/hurtownie.html">Dodaj hurtownię (CSV)</a>
      <a class="btn" href="/intelligence.html">Intelligence</a>
      <a class="btn" href="/listing.html">Listing</a>
      <a class="btn" href="/cennik.html">Plany</a>
      <a class="btn" href="/dashboard.html" data-auth-only>Dashboard</a>
    </div>
  </div>

  <div class="section">
    <div class="section-title reveal">
      <h2>Produkty</h2>
      <p>Sort: score → marża% → cena.</p>
    </div>

    <div id="qmToast" class="note" style="display:none;margin-bottom:12px;"></div>

    <div class="card reveal d2">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input class="input" id="qmSearch" placeholder="Szukaj po nazwie…" style="min-width:260px;">
          <select class="input" id="qmSupplierFilter" style="min-width:220px;"></select>
          <button class="btn btn-sm" type="button" id="qmReload">Odśwież</button>
          <button class="btn btn-sm btn-danger" type="button" id="qmClearGlobal">Wyczyść bazę hurtowni</button>
        </div>
        <div class="muted-xs" id="qmMeta">—</div>
      </div>

      <div class="hr"></div>

      <div style="overflow:auto;">
        <table class="table" id="qmGlobalTable">
          <thead>
            <tr>
              <th>Produkt</th>
              <th>Hurt</th>
              <th>Rynek</th>
              <th>Marża%</th>
              <th>Score</th>
              <th>Hurtownia</th>
              <th>Akcja</th>
            </tr>
          </thead>
          <tbody id="qmGlobalTbody"></tbody>
        </table>
      </div>

      <div class="muted-xs" style="margin-top:10px;">
        Tip: Jak masz 50k produktów, renderuję max 500 (żeby nie zabić przeglądarki).
      </div>
    </div>
  </div>
</div>

<div class="footer">© 2026 Zarabianie u Szefa × QualitetMarket</div>

<script>
  // ===== Plan badge + plan helpers (kanon) =====
  function normalizePlan(p){
    p = String(p || "").toLowerCase().trim();
    return (p === "elite") ? "elite" : (p === "pro" ? "pro" : "basic");
  }

  function getPlan(){
    // KANON: plain string
    const p = localStorage.getItem("qm_plan_v1") || localStorage.getItem("qm_status_v1") || "";
    const plan = normalizePlan(p);
    if (plan === "basic" || plan === "pro" || plan === "elite") return plan;

    // legacy fallback (tylko gdyby coś starego zostało)
    const legacy = String(localStorage.getItem("status") || "").toUpperCase();
    if (legacy === "ELITE") return "elite";
    if (legacy === "PRO") return "pro";
    return "basic";
  }

  function isElite(){ return getPlan() === "elite"; }

  (function renderPlanBadge(){
    const el = document.getElementById("planBadge");
    if (!el) return;
    const plan = getPlan();
    el.textContent = plan.toUpperCase();
    el.setAttribute("data-plan", plan);
  })();

  function logout() {
    localStorage.setItem("is_logged_in", "false");
    window.location.href = "/login.html";
  }

  (function () {
    const logged = localStorage.getItem("is_logged_in") === "true";
    document.querySelectorAll("[data-guest-only]").forEach(el => el.style.display = logged ? "none" : "");
    document.querySelectorAll("[data-auth-only]").forEach(el => el.style.display = logged ? "" : "none");
  })();

  const LS_PRODUCTS_BY_SUPPLIER = "qm_products_by_supplier_v1";
  const LS_INTEL_PREFILL = "qm_intel_prefill_v1";
  const LS_LISTING_PREFILL = "qm_listing_prefill_v1";

  const MAX_RENDER = 500;
  const $ = (s) => document.querySelector(s);

  function showToast(message, type="info"){
    const box = $("#qmToast");
    if (!box) return;
    box.style.display = "";
    box.textContent = message;

    box.style.border = "1px solid rgba(148,163,184,.25)";
    box.style.background = "rgba(148,163,184,.08)";

    if (type === "error") {
      box.style.border = "1px solid rgba(239,68,68,.35)";
      box.style.background = "rgba(239,68,68,.10)";
    } else if (type === "success") {
      box.style.border = "1px solid rgba(34,197,94,.30)";
      box.style.background = "rgba(34,197,94,.10)";
    }

    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> box.style.display="none", 2600);
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function formatPLN(n){
    const x = Number(n);
    if (!isFinite(x)) return "–";
    return x.toFixed(2) + " zł";
  }

  function loadProductsBySupplier(){
    try {
      const raw = localStorage.getItem(LS_PRODUCTS_BY_SUPPLIER);
      const list = raw ? JSON.parse(raw) : [];
      return Array.isArray(list) ? list : [];
    } catch {
      return [];
    }
  }

  function buildGlobalRows(suppliers){
    const out = [];
    for (const sup of suppliers) {
      const supplierName = sup?.supplierName || "Hurtownia";
      const products = Array.isArray(sup?.products) ? sup.products : [];
      for (const p of products) {
        out.push({
          name: p?.name || "",
          wholesale: isFinite(Number(p?.wholesale)) ? Number(p.wholesale) : null,
          retail: isFinite(Number(p?.retail)) ? Number(p.retail) : null,
          marginPct: isFinite(Number(p?.marginPct)) ? Number(p.marginPct) : null,
          score: isFinite(Number(p?.score)) ? Number(p.score) : 0,
          supplierName
        });
      }
    }
    return out;
  }

  function sortGlobal(rows){
    return rows.sort((a,b)=>
      (Number(b.score||0) - Number(a.score||0)) ||
      (Number(b.marginPct||0) - Number(a.marginPct||0)) ||
      (Number(b.retail||0) - Number(a.retail||0))
    );
  }

  function renderSupplierFilter(suppliers){
    const sel = $("#qmSupplierFilter");
    if (!sel) return;

    const names = suppliers.map(s => String(s?.supplierName || "Hurtownia")).filter(Boolean);
    const uniq = Array.from(new Set(names)).sort((a,b)=> a.localeCompare(b, "pl"));

    sel.innerHTML = `<option value="">Wszystkie hurtownie</option>` + uniq.map(n =>
      `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`
    ).join("");
  }

  function goIntel(row){
    localStorage.setItem(LS_INTEL_PREFILL, JSON.stringify({
      name: row.name,
      wholesale: row.wholesale,
      retail: row.retail,
      supplierName: row.supplierName,
      score: row.score,
      marginPct: row.marginPct
    }));
    window.location.href = "/intelligence.html";
  }

  function goListing(row){
    if (!isElite()) {
      showToast("Listing 1-klik wymaga planu ELITE (upgrade w Cennik).", "error");
      return;
    }

    localStorage.setItem(LS_LISTING_PREFILL, JSON.stringify({
      channel: "allegro",
      name: row.name,
      wholesale: row.wholesale,
      retail: row.retail,
      condition: "nowe",
      shipping: "tak",
      city: "",
      features: "",
      notes: row.supplierName ? ("Hurtownia: " + row.supplierName) : ""
    }));
    window.location.href = "/listing.html";
  }

  function renderTable(rows){
    const tbody = $("#qmGlobalTbody");
    if (!tbody) return;

    tbody.innerHTML = "";

    rows.slice(0, MAX_RENDER).forEach((r, idx)=>{
      const tr = document.createElement("tr");
      if (idx < 10) tr.style.background = "rgba(34,197,94,.08)";

      tr.innerHTML = `
        <td>${escapeHtml(r.name)}</td>
        <td>${formatPLN(r.wholesale)}</td>
        <td>${formatPLN(r.retail)}</td>
        <td>${isFinite(Number(r.marginPct)) ? Number(r.marginPct).toFixed(2) + "%" : "–"}</td>
        <td><strong>${Math.round(Number(r.score||0))}</strong></td>
        <td>${escapeHtml(r.supplierName)}</td>
        <td style="white-space:nowrap;">
          <button class="btn btn-sm btn-primary" data-action="intel" data-idx="${idx}">
            Wyślij do Intelligence
          </button>
          <button class="btn btn-sm btn-secondary" data-action="listing" data-require-btn="elite" data-idx="${idx}">
            Zrób Listing
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.onclick = (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const idx = Number(btn.getAttribute("data-idx"));
      const row = rows[idx];
      if (!row) return;

      if (action === "intel") return goIntel(row);
      if (action === "listing") return goListing(row);
    };
  }

  function applyFiltersAndRender(){
    const suppliers = loadProductsBySupplier();
    renderSupplierFilter(suppliers);

    const all = sortGlobal(buildGlobalRows(suppliers));

    const q = String($("#qmSearch")?.value || "").trim().toLowerCase();
    const sup = String($("#qmSupplierFilter")?.value || "").trim();

    let filtered = all;
    if (sup) filtered = filtered.filter(x => String(x.supplierName) === sup);
    if (q) filtered = filtered.filter(x => String(x.name||"").toLowerCase().includes(q));

    $("#qmMeta").textContent = `W bazie: ${all.length} • Widoczne: ${filtered.length} • Render: ${Math.min(filtered.length, MAX_RENDER)}`;

    if (!suppliers.length) showToast("Brak danych z hurtowni. Wejdź w Hurtownie i zaimportuj CSV.", "error");
    else showToast("Global TOP załadowany.", "success");

    renderTable(filtered);
  }

  function bind(){
    $("#qmReload")?.addEventListener("click", applyFiltersAndRender);
    $("#qmSearch")?.addEventListener("input", applyFiltersAndRender);
    $("#qmSupplierFilter")?.addEventListener("change", applyFiltersAndRender);

    $("#qmClearGlobal")?.addEventListener("click", () => {
      localStorage.removeItem(LS_PRODUCTS_BY_SUPPLIER);
      showToast("Wyczyszczono bazę hurtowni.", "success");
      applyFiltersAndRender();
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    bind();
    applyFiltersAndRender();

    (function () {
      const root = document.querySelector("[data-nav-root]");
      const btn = document.querySelector("[data-nav-toggle]");
      const links = document.querySelector("[data-nav-links]");
      if (!root || !btn || !links) return;

      const close = () => {
        root.classList.remove("nav-open");
        btn.setAttribute("aria-expanded", "false");
      };
      const toggle = () => {
        const open = root.classList.toggle("nav-open");
        btn.setAttribute("aria-expanded", open ? "true" : "false");
      };

      btn.addEventListener("click", toggle);
      links.addEventListener("click", (e) => {
        if (e.target.tagName === "A") close();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") close();
      });
    })();
  });
</script>

</body>
</html>
