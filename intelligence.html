<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Intelligence – Zarabianie u Szefa</title>
  <link rel="stylesheet" href="styles.css">

  <!-- planGuard fallback: /js/ oraz root -->
  <script>
    (function () {
      const tryLoad = (src, next) => {
        const s = document.createElement("script");
        s.defer = true;
        s.src = src;
        s.onerror = () => next && next();
        document.head.appendChild(s);
      };
      tryLoad("js/planGuard.js", () => tryLoad("planGuard.js"));
    })();
  </script>
</head>

<body data-require="elite">

<div class="nav" data-nav-root>
  <div class="nav-inner">
    <div class="brand">
      <div class="logo"></div>
      <div class="brand-title">QualitetMarket</div>
      <span id="planBadge" class="plan-badge"></span>
    </div>

    <button class="nav-toggle" type="button" aria-label="Menu" aria-expanded="false" data-nav-toggle>
      <span></span><span></span><span></span>
    </button>

    <div class="nav-links" data-nav-links>
      <a href="index.html">Start</a>
      <a href="cennik.html">Plany</a>
      <a href="qualitetmarket.html">QualitetMarket</a>
      <a class="active" href="intelligence.html">Intelligence</a>
      <a href="blueprints.html">Blueprints</a>
      <a href="hurtownie.html" id="hurtownieLink">Hurtownie</a>
      <a href="dashboard.html" data-auth-only>Dashboard</a>

      <div class="nav-links-sep"></div>

      <a class="btn btn-sm btn-primary" href="login.html" data-guest-only>Zaloguj</a>
      <a class="btn btn-sm" href="aktywuj-pro.html" data-guest-only>Aktywuj PRO</a>

      <button class="btn btn-sm btn-danger" type="button" onclick="logout()" data-auth-only>Wyloguj</button>
    </div>
  </div>
</div>

<div class="wrap">

  <div class="hero-card reveal">
    <span class="badge"><span class="dot"></span> QualitetMarket • Scoring</span>
    <div class="h1">Intelligence</div>
    <div class="p">Wpisz parametry produktu i dostajesz marżę, BEP oraz prosty score “czy warto” — bez backendu.</div>

    <div class="hr"></div>

    <div class="hero-cta">
      <a class="btn btn-secondary" href="hurtownie.html">Zaciągnij z Hurtowni</a>
      <a class="btn" href="blueprints.html">Blueprints</a>
      <a class="btn" href="dashboard.html" data-auth-only>Dashboard</a>
      <a class="btn" href="cennik.html">Upgrade planu</a>
    </div>
  </div>

  <div class="section">
    <div class="section-title reveal">
      <h2>Kalkulator opłacalności</h2>
      <p>Uzupełnij pola i kliknij “Policz”.</p>
    </div>

    <!-- ✅ toast (prefill / status) -->
    <div id="qmIntelToast" class="note" style="display:none;margin-bottom:12px;"></div>

    <div class="grid-2">
      <div class="card reveal d2">
        <h3 style="margin:0 0 10px;">Dane produktu</h3>

        <label class="label">Nazwa produktu</label>
        <input class="input" id="pName" placeholder="np. Etui do iPhone 15" />

        <div style="height:10px"></div>

        <div class="grid-2">
          <div>
            <label class="label">Cena hurtowa (zakup)</label>
            <input class="input" id="buy" type="number" step="0.01" placeholder="np. 19.90" />
          </div>
          <div>
            <label class="label">Cena sprzedaży (brutto)</label>
            <input class="input" id="sell" type="number" step="0.01" placeholder="np. 59.90" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="grid-2">
          <div>
            <label class="label">Koszt wysyłki</label>
            <input class="input" id="ship" type="number" step="0.01" placeholder="np. 10.00" />
          </div>
          <div>
            <label class="label">Prowizje / fees</label>
            <input class="input" id="fee" type="number" step="0.01" placeholder="np. 6.00" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="grid-2">
          <div>
            <label class="label">Reklama / koszt pozyskania</label>
            <input class="input" id="ads" type="number" step="0.01" placeholder="np. 8.00" />
          </div>
          <div>
            <label class="label">Zwroty / ryzyko (zł)</label>
            <input class="input" id="risk" type="number" step="0.01" placeholder="np. 3.00" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="hero-cta" style="margin:0;flex-wrap:wrap;">
          <button class="btn btn-primary" type="button" onclick="calc()">Policz</button>
          <button class="btn" type="button" onclick="resetCalc()">Wyczyść</button>
          <button class="btn btn-secondary" type="button" id="qmCopyResultBtn">Kopiuj wynik</button>
          <button class="btn" type="button" id="qmTargetPriceBtn">Ustaw cenę pod target</button>
        </div>

        <div class="hr"></div>

        <div class="note">
          <strong>Skrót:</strong> Ctrl+Shift+K ustawiasz prywatne koszty (ship/fee/ads/risk) raz i masz je zawsze.
        </div>
      </div>

      <div class="card reveal d3">
        <h3 style="margin:0 0 10px;">Wynik</h3>

        <div class="grid-3" style="margin-top:0;">
          <div class="kpi">
            <div>
              <strong>Marża</strong>
              <div class="muted-xs">zysk / szt.</div>
            </div>
            <span id="outProfit">—</span>
          </div>

          <div class="kpi">
            <div>
              <strong>Marża %</strong>
              <div class="muted-xs">profit / cena</div>
            </div>
            <span id="outMargin">—</span>
          </div>

          <div class="kpi">
            <div>
              <strong>Score</strong>
              <div class="muted-xs">0–100</div>
            </div>
            <span id="outScore">—</span>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid-2">
          <div class="card soft">
            <h3 style="margin:0 0 6px;">BEP (break-even)</h3>
            <p class="p" style="margin:0;">Minimalna cena sprzedaży, żeby wyjść na 0.</p>
            <div class="hr"></div>
            <div class="p" style="font-weight:900;margin:0;" id="outBep">—</div>
          </div>

          <div class="card soft">
            <h3 style="margin:0 0 6px;">Rekomendacja</h3>
            <p class="p" style="margin:0;" id="outReco">—</p>
            <div class="hr"></div>
            <div class="muted-xs" id="outWhy">—</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card soft">
          <h3 style="margin:0 0 6px;">Szybki audyt (auto)</h3>
          <div class="muted-xs" id="qmAudit">—</div>
        </div>

        <div class="hr"></div>

        <div class="card soft">
          <h3 style="margin:0 0 6px;">Checklist do odpalenia sprzedaży</h3>
          <div class="muted-xs">1) 3 zdjęcia + 1 wideo</div>
          <div class="muted-xs">2) 1 mocny tytuł + 3 bullet’y</div>
          <div class="muted-xs">3) 1 kanał ruchu (OLX / Allegro / TikTok)</div>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="footer">© 2026 Zarabianie u Szefa × QualitetMarket</div>

<!-- app.js fallback: assets/ oraz root -->
<script>
  (function () {
    const tryLoad = (src, next) => {
      const s = document.createElement("script");
      s.defer = true;
      s.src = src;
      s.onerror = () => next && next();
      document.body.appendChild(s);
    };
    tryLoad("assets/app.js", () => tryLoad("app.js"));
  })();
</script>

<script>
  function logout() {
    localStorage.setItem("is_logged_in", "false");
    window.location.href = "login.html";
  }

  // CTA w nav: guest vs logged
  (function () {
    const logged = localStorage.getItem("is_logged_in") === "true";
    document.querySelectorAll("[data-guest-only]").forEach(el => el.style.display = logged ? "none" : "");
    document.querySelectorAll("[data-auth-only]").forEach(el => el.style.display = logged ? "" : "none");
  })();

  function n(v){ v = Number(v); return isFinite(v) ? v : 0; }
  function money(x){ return (Math.round(x*100)/100).toFixed(2) + " zł"; }

  function showToast(msg, type="info"){
    const toast = document.getElementById("qmIntelToast");
    if (!toast) return;
    toast.style.display = "";
    toast.textContent = msg;

    toast.style.border = "1px solid rgba(148,163,184,.25)";
    toast.style.background = "rgba(148,163,184,.08)";
    if (type === "error") {
      toast.style.border = "1px solid rgba(239,68,68,.35)";
      toast.style.background = "rgba(239,68,68,.10)";
    } else if (type === "success") {
      toast.style.border = "1px solid rgba(34,197,94,.30)";
      toast.style.background = "rgba(34,197,94,.10)";
    }

    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display="none", 2600);
  }

  function setAudit(text){
    const el = document.getElementById("qmAudit");
    if (!el) return;
    el.textContent = text || "—";
  }

  function calc(){
    const buy = n(document.getElementById("buy").value);
    const sell = n(document.getElementById("sell").value);
    const ship = n(document.getElementById("ship").value);
    const fee  = n(document.getElementById("fee").value);
    const ads  = n(document.getElementById("ads").value);
    const risk = n(document.getElementById("risk").value);

    const cost = buy + ship + fee + ads + risk;
    const profit = sell - cost;
    const margin = sell > 0 ? (profit / sell) * 100 : 0;
    const bep = cost;

    let score = 0;
    if (profit <= 0) score = 0;
    else {
      score += Math.min(40, (profit / Math.max(1, buy)) * 25);
      score += Math.min(40, margin * 1.2);
      score += Math.max(0, 20 - (ads * 1.5));
      score = Math.max(0, Math.min(100, score));
    }

    document.getElementById("outProfit").textContent = money(profit);
    document.getElementById("outMargin").textContent = (Math.round(margin*10)/10).toFixed(1) + "%";
    document.getElementById("outScore").textContent = Math.round(score);

    document.getElementById("outBep").textContent = money(bep);

    let reco = "Odrzuć";
    let why = "Zysk ≤ 0 albo marża za niska.";
    if (profit > 0 && margin >= 25 && score >= 60){
      reco = "Bierz i testuj";
      why = "Marża i score wyglądają dobrze – rób listing i ruch.";
    } else if (profit > 0 && margin >= 15 && score >= 40){
      reco = "Warunkowo";
      why = "Może przejść, ale tnij koszty (ads/fees) albo podnieś cenę.";
    } else if (profit > 0){
      reco = "Słabe";
      why = "Jest zysk, ale mały – ryzyko zjada wynik.";
    }

    document.getElementById("outReco").textContent = reco;
    document.getElementById("outWhy").textContent = why;

    // ✅ AUTO AUDYT (nie blokuje, tylko informuje)
    const warn = [];
    if (profit > 0 && profit < 20) warn.push("Profit < 20 zł (słaba poduszka).");
    if (profit <= 0) warn.push("Profit ≤ 0 (nieopłacalne).");
    if (margin > 0 && margin < 15) warn.push("Marża % < 15% (mały margines na reklamę/zwroty).");
    if (ads > 0 && ads > profit) warn.push("Reklama zjada profit (ads > profit).");
    setAudit(warn.length ? warn.join(" ") : "OK: wynik wygląda zdrowo.");

    return { buy, sell, ship, fee, ads, risk, cost, profit, margin, bep, score };
  }

  function resetCalc(){
    ["pName","buy","sell","ship","fee","ads","risk"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
    ["outProfit","outMargin","outScore","outBep","outReco","outWhy"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.textContent = "—";
    });
    setAudit("—");
  }

  // ✅ GLOBAL COST PRESET (PRIVATE) — Ctrl+Shift+K
  (function setupGlobalCosts(){
    const LS_COST_PRESET = "qm_cost_preset_v1";

    function getPreset(){
      try {
        const raw = localStorage.getItem(LS_COST_PRESET);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function setPreset(obj){
      localStorage.setItem(LS_COST_PRESET, JSON.stringify(obj));
    }

    function applyPreset(force=false){
      const p = getPreset();
      if (!p) return;

      const ship = document.getElementById("ship");
      const fee  = document.getElementById("fee");
      const ads  = document.getElementById("ads");
      const risk = document.getElementById("risk");

      const put = (el, v) => {
        if (!el) return;
        if (force || el.value === "" || el.value == null) el.value = String(Number(v ?? 0));
      };

      put(ship, p.ship);
      put(fee,  p.fee);
      put(ads,  p.ads);
      put(risk, p.risk);
    }

    document.addEventListener("keydown", function(e){
      if (!e.ctrlKey || !e.shiftKey) return;
      if (String(e.key).toLowerCase() !== "k") return;

      e.preventDefault();

      const current = getPreset() || {ship:0, fee:0, ads:0, risk:0};

      const ship = prompt("Domyślna wysyłka:", current.ship);
      if (ship === null) return;

      const fee = prompt("Domyślne prowizje:", current.fee);
      if (fee === null) return;

      const ads = prompt("Domyślna reklama:", current.ads);
      if (ads === null) return;

      const risk = prompt("Domyślne ryzyko:", current.risk);
      if (risk === null) return;

      setPreset({
        ship: Number(ship),
        fee: Number(fee),
        ads: Number(ads),
        risk: Number(risk)
      });

      showToast("Zapisano globalne koszty (Ctrl+Shift+K).", "success");
      applyPreset(true);
      try { calc(); } catch {}
    });

    document.addEventListener("DOMContentLoaded", () => applyPreset(false));

    // expose for prefill
    window.qmApplyPreset = applyPreset;
  })();

  // ✅ PREFILL z QualitetMarket → Intelligence
  (function prefillFromQualitetMarket(){
    const LS_INTEL_PREFILL = "qm_intel_prefill_v1";

    let payload = null;
    try {
      const raw = localStorage.getItem(LS_INTEL_PREFILL);
      payload = raw ? JSON.parse(raw) : null;
    } catch { payload = null; }

    if (!payload || !payload.name) return;

    // wypełnij pola
    const pName = document.getElementById("pName");
    const buy   = document.getElementById("buy");
    const sell  = document.getElementById("sell");

    if (pName) pName.value = String(payload.name || "");
    if (buy && Number.isFinite(Number(payload.wholesale))) buy.value = Number(payload.wholesale).toFixed(2);
    if (sell && Number.isFinite(Number(payload.retail))) sell.value = Number(payload.retail).toFixed(2);

    // zastosuj preset kosztów (jeśli ustawiony)
    try { window.qmApplyPreset && window.qmApplyPreset(false); } catch {}

    // jeśli nadal puste — ustaw 0
    ["ship","fee","ads","risk"].forEach(id => {
      const el = document.getElementById(id);
      if (el && (el.value === "" || el.value == null)) el.value = "0";
    });

    // policz
    try { calc(); } catch {}

    const sup = payload.supplierName ? ` • Hurtownia: ${payload.supplierName}` : "";
    showToast(`Zaciągnięto produkt z QualitetMarket${sup}.`, "success");

    // wyczyść, żeby nie prefillowało w kółko
    localStorage.removeItem(LS_INTEL_PREFILL);
  })();

  // ✅ Kopiuj wynik do schowka (listing / notatki)
  (function bindCopy(){
    const btn = document.getElementById("qmCopyResultBtn");
    if (!btn) return;

    btn.addEventListener("click", async () => {
      const res = calc();
      const name = (document.getElementById("pName").value || "Produkt").trim();

      const text =
`[Intelligence]
Produkt: ${name}
Buy: ${res.buy.toFixed(2)} zł
Sell: ${res.sell.toFixed(2)} zł
Koszty: ship ${res.ship.toFixed(2)}, fee ${res.fee.toFixed(2)}, ads ${res.ads.toFixed(2)}, risk ${res.risk.toFixed(2)}
Profit: ${res.profit.toFixed(2)} zł
Marża%: ${res.margin.toFixed(1)}%
BEP: ${res.bep.toFixed(2)} zł
Score: ${Math.round(res.score)}`;

      try {
        await navigator.clipboard.writeText(text);
        showToast("Skopiowano wynik do schowka.", "success");
      } catch {
        showToast("Nie mogę skopiować (blokada przeglądarki). Zaznacz i skopiuj ręcznie.", "error");
        alert(text);
      }
    });
  })();

  // ✅ Ustaw cenę sprzedaży pod target (marża% lub profit zł)
  (function bindTarget(){
    const btn = document.getElementById("qmTargetPriceBtn");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const buy = n(document.getElementById("buy").value);
      const ship = n(document.getElementById("ship").value);
      const fee  = n(document.getElementById("fee").value);
      const ads  = n(document.getElementById("ads").value);
      const risk = n(document.getElementById("risk").value);

      const cost = buy + ship + fee + ads + risk;
      if (cost <= 0) return showToast("Uzupełnij koszt zakupu i koszty.", "error");

      const mode = prompt("Wpisz: M=marża% albo P=profit zł (np. M25 albo P30):", "M25");
      if (!mode) return;

      const m = mode.trim().toUpperCase();
      const type = m.startsWith("P") ? "P" : "M";
      const val = Number(m.slice(1).replace(",", "."));

      if (!isFinite(val) || val < 0) return showToast("Zły format targetu.", "error");

      let sell = 0;

      if (type === "P") {
        // target profit zł: sell = cost + profit
        sell = cost + val;
      } else {
        // target margin%: margin = (sell - cost)/sell
        // => sell = cost / (1 - margin)
        const target = val / 100;
        if (target >= 0.95) return showToast("Marża% za wysoka (>=95%).", "error");
        sell = cost / (1 - target);
      }

      if (!isFinite(sell) || sell <= 0) return showToast("Nie da się policzyć ceny.", "error");

      document.getElementById("sell").value = sell.toFixed(2);
      calc();
      showToast(`Ustawiono cenę sprzedaży: ${sell.toFixed(2)} zł`, "success");
    });
  })();

  // mobilne menu (hamburger)
  (function () {
    const root = document.querySelector("[data-nav-root]");
    const btn = document.querySelector("[data-nav-toggle]");
    const links = document.querySelector("[data-nav-links]");
    if (!root || !btn || !links) return;

    const close = () => {
      root.classList.remove("nav-open");
      btn.setAttribute("aria-expanded", "false");
    };
    const toggle = () => {
      const open = root.classList.toggle("nav-open");
      btn.setAttribute("aria-expanded", open ? "true" : "false");
    };

    btn.addEventListener("click", toggle);
    links.addEventListener("click", (e) => {
      if (e.target.tagName === "A") close();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") close();
    });
  })();
</script>

</body>
</html>
