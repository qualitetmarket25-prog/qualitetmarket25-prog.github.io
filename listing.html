<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listing Generator – QualitetMarket</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    textarea.input { min-height: 140px; resize: vertical; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.25); background: rgba(148,163,184,.08); font-size:12px; color:#cbd5e1;}
    .pill .dot { width:8px;height:8px;border-radius:999px;background:rgba(34,197,94,.9); display:inline-block;}
    .kpi small{ display:block; color:#94a3b8; font-weight:500; }
  </style>

  <!-- planGuard fallback -->
  <script>
    (function () {
      const tryLoad = (src, next) => {
        const s = document.createElement("script");
        s.defer = true;
        s.src = src;
        s.onerror = () => next && next();
        document.head.appendChild(s);
      };
      tryLoad("js/planGuard.js", () => tryLoad("planGuard.js"));
    })();
  </script>
</head>

<body data-require="pro">

<div class="nav" data-nav-root>
  <div class="nav-inner">
    <div class="brand">
      <div class="logo"></div>
      <div class="brand-title">QualitetMarket</div>
      <span id="planBadge" class="plan-badge"></span>
    </div>

    <button class="nav-toggle" type="button" aria-label="Menu" aria-expanded="false" data-nav-toggle>
      <span></span><span></span><span></span>
    </button>

    <div class="nav-links" data-nav-links>
      <a href="index.html">Start</a>
      <a href="cennik.html">Plany</a>
      <a href="qualitetmarket.html">QualitetMarket</a>
      <a href="intelligence.html">Intelligence</a>
      <a class="active" href="listing.html">Listing</a>
      <a href="hurtownie.html" id="hurtownieLink">Hurtownie</a>
      <a href="dashboard.html" data-auth-only>Dashboard</a>

      <div class="nav-links-sep"></div>

      <a class="btn btn-sm btn-primary" href="login.html" data-guest-only>Zaloguj</a>
      <a class="btn btn-sm" href="aktywuj-pro.html" data-guest-only>Aktywuj PRO</a>

      <button class="btn btn-sm btn-danger" type="button" onclick="logout()" data-auth-only>Wyloguj</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="hero-card reveal">
    <span class="badge"><span class="dot"></span> QualitetMarket • Generator sprzedaży</span>
    <div class="h1">Listing Generator</div>
    <div class="p">Szybki tytuł + bullets + opis pod Allegro/OLX/FB/Vinted. 1 klik kopiuj i wrzucasz.</div>

    <div class="hr"></div>

    <div class="hero-cta">
      <a class="btn btn-secondary" href="intelligence.html">Wróć do Intelligence</a>
      <a class="btn" href="qualitetmarket.html">Global TOP</a>
      <button class="btn btn-primary" type="button" id="btnGenerate">Generuj</button>
      <button class="btn" type="button" id="btnClear">Wyczyść</button>
    </div>

    <div class="hr"></div>

    <div id="toast" class="note" style="display:none;"></div>
  </div>

  <div class="section">
    <div class="section-title reveal">
      <h2>Parametry</h2>
      <p>Uzupełnij minimum. Reszta jest auto.</p>
    </div>

    <div class="grid-2">
      <div class="card reveal d2">
        <h3 style="margin:0 0 10px;">Dane</h3>

        <label class="label">Kanał</label>
        <select class="input" id="channel">
          <option value="allegro">Allegro (max sprzedaż)</option>
          <option value="olx">OLX (szybka sprzedaż lokalnie)</option>
          <option value="fb">Facebook Marketplace (szybko + negocjacje)</option>
          <option value="vinted">Vinted (moda/akcesoria/małe rzeczy)</option>
        </select>

        <div style="height:10px"></div>

        <label class="label">Nazwa produktu</label>
        <input class="input" id="name" placeholder="np. Etui do iPhone 15 – nowe" />

        <div style="height:10px"></div>

        <div class="grid-2">
          <div>
            <label class="label">Stan</label>
            <select class="input" id="condition">
              <option value="nowe">Nowe</option>
              <option value="uzywane">Używane</option>
              <option value="jak_nowe">Jak nowe</option>
              <option value="powystawowe">Powystawowe</option>
            </select>
          </div>
          <div>
            <label class="label">Wysyłka?</label>
            <select class="input" id="shipping">
              <option value="tak">Tak</option>
              <option value="nie">Nie, odbiór</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="grid-2">
          <div>
            <label class="label">Cena zakupu (hurt)</label>
            <input class="input" id="buy" type="number" step="0.01" placeholder="np. 19.90" />
          </div>
          <div>
            <label class="label">Cena rynkowa (rynek)</label>
            <input class="input" id="market" type="number" step="0.01" placeholder="np. 59.90" />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="grid-2">
          <div>
            <label class="label">Twoja cena (jeśli chcesz wymusić)</label>
            <input class="input" id="price" type="number" step="0.01" placeholder="np. 54.90" />
          </div>
          <div>
            <label class="label">Miasto / odbiór</label>
            <input class="input" id="city" placeholder="np. Warszawa" />
          </div>
        </div>

        <div class="hr"></div>

        <label class="label">3 cechy (opcjonalnie, po przecinku)</label>
        <input class="input" id="features" placeholder="np. odporne, cienkie, magnes" />

        <div style="height:10px"></div>

        <label class="label">Uwagi (opcjonalnie)</label>
        <input class="input" id="notes" placeholder="np. pasuje do iPhone 15 Pro, kolor czarny" />

        <div class="hr"></div>

        <div class="grid-3">
          <div class="kpi">
            <div><strong>Sugerowana cena</strong><small>(auto)</small></div>
            <span id="kPrice">—</span>
          </div>
          <div class="kpi">
            <div><strong>Marża</strong><small>(z grubsza)</small></div>
            <span id="kMargin">—</span>
          </div>
          <div class="kpi">
            <div><strong>Strategia</strong><small>(kanał)</small></div>
            <span id="kStrat">—</span>
          </div>
        </div>
      </div>

      <div class="card reveal d3">
        <h3 style="margin:0 0 10px;">Wynik</h3>

        <div class="hero-cta" style="margin:0;flex-wrap:wrap;">
          <button class="btn btn-sm btn-secondary" id="copyTitle" type="button">Kopiuj tytuł</button>
          <button class="btn btn-sm btn-secondary" id="copyBullets" type="button">Kopiuj bullets</button>
          <button class="btn btn-sm btn-secondary" id="copyDesc" type="button">Kopiuj opis</button>
          <button class="btn btn-sm btn-primary" id="copyAll" type="button">Kopiuj całość</button>
        </div>

        <div class="hr"></div>

        <label class="label">Tytuł</label>
        <textarea class="input mono" id="outTitle"></textarea>

        <div style="height:10px"></div>

        <label class="label">Bullets</label>
        <textarea class="input mono" id="outBullets"></textarea>

        <div style="height:10px"></div>

        <label class="label">Opis</label>
        <textarea class="input" id="outDesc"></textarea>

        <div style="height:10px"></div>

        <label class="label">Hashtagi / tagi (opcjonalnie)</label>
        <textarea class="input mono" id="outTags"></textarea>

        <div class="hr"></div>

        <div class="note">
          <span class="pill"><span class="dot"></span> Tip</span>
          Na Allegro i OLX najlepiej działa: <strong>krótki tytuł + konkrety + stan + odbiór/wysyłka</strong>.
        </div>
      </div>
    </div>
  </div>
</div>

<div class="footer">© 2026 Zarabianie u Szefa × QualitetMarket</div>

<script>
  function logout() {
    localStorage.setItem("is_logged_in", "false");
    window.location.href = "login.html";
  }

  const LS_PREFILL = "qm_listing_prefill_v1";

  const $ = (s) => document.querySelector(s);
  const n = (v) => { v = Number(v); return isFinite(v) ? v : 0; };

  function toast(msg, type="info"){
    const t = $("#toast");
    if (!t) return;
    t.style.display = "";
    t.textContent = msg;

    t.style.border = "1px solid rgba(148,163,184,.25)";
    t.style.background = "rgba(148,163,184,.08)";
    if (type === "error") { t.style.border = "1px solid rgba(239,68,68,.35)"; t.style.background="rgba(239,68,68,.10)"; }
    if (type === "success") { t.style.border = "1px solid rgba(34,197,94,.30)"; t.style.background="rgba(34,197,94,.10)"; }

    clearTimeout(toast._t);
    toast._t = setTimeout(()=> t.style.display="none", 2600);
  }

  function roundToPsychPrice(x){
    if (!isFinite(x) || x <= 0) return 0;
    // psychologiczne końcówki: .99 / .90
    const base = Math.max(1, x);
    const floor = Math.floor(base);
    const frac = base - floor;
    // jeśli < .50 => .99, jeśli >= .50 => .90
    const out = floor + (frac < 0.5 ? 0.99 : 0.90);
    return Math.round(out * 100) / 100;
  }

  function pickStrategy(channel){
    if (channel === "allegro") return { feePct: 0.10, discountPct: 0.06, label: "Allegro: konkurencja → cena -6% vs rynek" };
    if (channel === "olx") return { feePct: 0.00, discountPct: 0.08, label: "OLX: szybko → cena -8% vs rynek (negocjacje)" };
    if (channel === "fb") return { feePct: 0.00, discountPct: 0.10, label: "FB: targowanie → cena -10% vs rynek" };
    if (channel === "vinted") return { feePct: 0.00, discountPct: 0.12, label: "Vinted: szybkie → cena -12% vs rynek" };
    return { feePct: 0.00, discountPct: 0.08, label: "Standard" };
  }

  function suggestPrice({ channel, market, buy, forcedPrice }){
    const strat = pickStrategy(channel);
    const m = n(market);
    const b = n(buy);

    // baza: rynek minus discount
    let p = m > 0 ? (m * (1 - strat.discountPct)) : 0;

    // jeśli brak rynku: użyj prostej reguły: buy * 2.7 (popularny sweet spot dla drobnicy)
    if (p <= 0 && b > 0) p = b * 2.7;

    // minimalna ochrona marży: przynajmniej +35% na zakup (jeśli się da)
    if (b > 0) p = Math.max(p, b * 1.35);

    // wymuszona cena
    if (isFinite(Number(forcedPrice)) && Number(forcedPrice) > 0) p = Number(forcedPrice);

    return { price: roundToPsychPrice(p), strat };
  }

  function computeMargin(buy, price, channel){
    const strat = pickStrategy(channel);
    const fees = n(price) * strat.feePct;
    const profit = n(price) - n(buy) - fees;
    const marginPct = n(price) > 0 ? (profit / n(price)) * 100 : 0;
    return { profit, marginPct, fees };
  }

  function cleanTokens(s){
    return String(s || "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function buildCopy({ channel, name, condition, shipping, city, price, buy, features, notes }){
    const tokens = [];
    const f = (features || "").split(",").map(x=> cleanTokens(x)).filter(Boolean).slice(0,3);
    const note = cleanTokens(notes);

    const condLabel =
      condition === "nowe" ? "NOWE" :
      condition === "jak_nowe" ? "JAK NOWE" :
      condition === "powystawowe" ? "POWYSTAWOWE" : "UŻYWANE";

    const shipLabel = shipping === "tak" ? "Wysyłka + odbiór" : "Odbiór osobisty";

    // tytuł zależny od kanału (krótki, wyszukiwalny)
    const baseName = cleanTokens(name).slice(0, 70);
    const t =
      channel === "allegro" ? `${baseName} • ${condLabel}` :
      channel === "olx" ? `${baseName} - ${condLabel} ${city ? " | " + city : ""}` :
      channel === "fb" ? `${baseName} (${condLabel})` :
      `${baseName} • ${condLabel}`;

    // bullets (najlepiej działają 3–6)
    const bullets = [
      `Stan: ${condLabel}`,
      shipLabel + (city ? ` • ${city}` : ""),
      price > 0 ? `Cena: ${price.toFixed(2)} zł` : null,
      f[0] ? `Cecha 1: ${f[0]}` : null,
      f[1] ? `Cecha 2: ${f[1]}` : null,
      f[2] ? `Cecha 3: ${f[2]}` : null,
      note ? `Uwagi: ${note}` : null
    ].filter(Boolean);

    // opis zależny od kanału (Allegro bardziej formalne, FB bardziej ludzkie)
    let desc = "";
    if (channel === "allegro") {
      desc =
`Sprzedam: ${baseName}

✅ Stan: ${condLabel}
✅ ${shipLabel}${city ? " (" + city + ")" : ""}
✅ Cena: ${price.toFixed(2)} zł

Opis:
${note ? note : "Produkt zgodny z opisem. Możliwa szybka wysyłka lub odbiór."}

W razie pytań — pisz.`;
    } else if (channel === "olx") {
      desc =
`${baseName}

Stan: ${condLabel}
Cena: ${price.toFixed(2)} zł
${shipLabel}${city ? " • " + city : ""}

${note ? note + "\n\n" : ""}Szybka sprzedaż. Jeśli ogłoszenie jest aktywne – aktualne.`;
    } else if (channel === "fb") {
      desc =
`${baseName} (${condLabel})

Cena: ${price.toFixed(2)} zł
${shipLabel}${city ? " • " + city : ""}

${note ? note + "\n\n" : ""}Odbiór możliwy dziś/jutro. Proszę pisać priv.`;
    } else {
      // vinted
      desc =
`${baseName}

Stan: ${condLabel}
Cena: ${price.toFixed(2)} zł
${shipLabel}

${note ? note + "\n\n" : ""}Wysyłam szybko.`;
    }

    const tags = buildTags(baseName, f, channel);

    return {
      title: t,
      bullets: bullets.map(x => "• " + x).join("\n"),
      desc,
      tags
    };
  }

  function buildTags(name, featuresArr, channel){
    const base = cleanTokens(name)
      .toLowerCase()
      .replace(/[^\p{L}\p{N}\s]/gu, " ")
      .replace(/\s+/g, " ")
      .trim();

    const words = base.split(" ").filter(w => w.length >= 3).slice(0, 8);
    const extra = (featuresArr || []).map(x=> cleanTokens(x).toLowerCase()).filter(Boolean).slice(0, 5);
    const all = Array.from(new Set([...words, ...extra])).slice(0, 12);

    if (channel === "fb") return all.map(w => "#" + w.replace(/\s+/g,"")).join(" ");
    if (channel === "vinted") return all.join(", ");
    return all.join(", ");
  }

  function writeOutputs(o){
    $("#outTitle").value = o.title || "";
    $("#outBullets").value = o.bullets || "";
    $("#outDesc").value = o.desc || "";
    $("#outTags").value = o.tags || "";
  }

  async function copyText(text){
    try {
      await navigator.clipboard.writeText(text);
      toast("Skopiowano do schowka.", "success");
    } catch {
      toast("Nie mogę skopiować (blokada). Skopiuj ręcznie.", "error");
      alert(text);
    }
  }

  function generate(){
    const channel = $("#channel").value;
    const name = cleanTokens($("#name").value);
    const condition = $("#condition").value;
    const shipping = $("#shipping").value;
    const city = cleanTokens($("#city").value);
    const buy = n($("#buy").value);
    const market = n($("#market").value);
    const forcedPrice = $("#price").value;
    const features = $("#features").value;
    const notes = $("#notes").value;

    if (!name) return toast("Wpisz nazwę produktu.", "error");

    const { price, strat } = suggestPrice({ channel, market, buy, forcedPrice });
    const m = computeMargin(buy, price, channel);

    $("#kPrice").textContent = price > 0 ? price.toFixed(2) + " zł" : "—";
    $("#kMargin").textContent = (isFinite(m.marginPct) ? m.marginPct.toFixed(1) : "0.0") + "%";
    $("#kStrat").textContent = strat.label;

    const copy = buildCopy({ channel, name, condition, shipping, city, price, buy, features, notes });
    writeOutputs(copy);

    // zapisz “ostatni listing” (żeby wrócić)
    localStorage.setItem("qm_last_listing_v1", JSON.stringify({
      channel, name, condition, shipping, city, buy, market, forcedPrice, features, notes
    }));

    toast("Wygenerowano listing.", "success");
  }

  function clearAll(){
    ["name","buy","market","price","city","features","notes"].forEach(id => $("#"+id).value = "");
    $("#outTitle").value = "";
    $("#outBullets").value = "";
    $("#outDesc").value = "";
    $("#outTags").value = "";
    $("#kPrice").textContent = "—";
    $("#kMargin").textContent = "—";
    $("#kStrat").textContent = "—";
    toast("Wyczyszczono.", "success");
  }

  function loadPrefill(){
    // 1) prefill z Intelligence
    let p = null;
    try {
      const raw = localStorage.getItem(LS_PREFILL);
      p = raw ? JSON.parse(raw) : null;
    } catch { p = null; }

    if (p) {
      if (p.channel) $("#channel").value = p.channel;
      if (p.name) $("#name").value = p.name;
      if (isFinite(Number(p.wholesale))) $("#buy").value = Number(p.wholesale).toFixed(2);
      if (isFinite(Number(p.retail))) $("#market").value = Number(p.retail).toFixed(2);
      if (p.city) $("#city").value = p.city;
      if (p.condition) $("#condition").value = p.condition;
      if (p.shipping) $("#shipping").value = p.shipping;
      if (p.features) $("#features").value = p.features;
      if (p.notes) $("#notes").value = p.notes;

      localStorage.removeItem(LS_PREFILL);
      toast("Zaciągnięto dane z Intelligence.", "success");
      return;
    }

    // 2) fallback: ostatnio użyte
    try {
      const raw = localStorage.getItem("qm_last_listing_v1");
      const last = raw ? JSON.parse(raw) : null;
      if (last) {
        if (last.channel) $("#channel").value = last.channel;
        if (last.name) $("#name").value = last.name;
        if (isFinite(Number(last.buy))) $("#buy").value = Number(last.buy).toFixed(2);
        if (isFinite(Number(last.market))) $("#market").value = Number(last.market).toFixed(2);
        if (last.forcedPrice) $("#price").value = last.forcedPrice;
        if (last.city) $("#city").value = last.city;
        if (last.condition) $("#condition").value = last.condition;
        if (last.shipping) $("#shipping").value = last.shipping;
        if (last.features) $("#features").value = last.features;
        if (last.notes) $("#notes").value = last.notes;
      }
    } catch {}
  }

  function bind(){
    $("#btnGenerate").addEventListener("click", generate);
    $("#btnClear").addEventListener("click", clearAll);

    $("#copyTitle").addEventListener("click", ()=> copyText($("#outTitle").value));
    $("#copyBullets").addEventListener("click", ()=> copyText($("#outBullets").value));
    $("#copyDesc").addEventListener("click", ()=> copyText($("#outDesc").value));
    $("#copyAll").addEventListener("click", ()=> {
      const text =
`${$("#outTitle").value}

${$("#outBullets").value}

${$("#outDesc").value}

Tagi: ${$("#outTags").value}`;
      copyText(text);
    });

    // auto-generate po zmianie kanału, jeśli jest nazwa
    $("#channel").addEventListener("change", ()=> {
      if (cleanTokens($("#name").value)) generate();
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    bind();
    loadPrefill();

    // mobile menu
    (function () {
      const root = document.querySelector("[data-nav-root]");
      const btn = document.querySelector("[data-nav-toggle]");
      const links = document.querySelector("[data-nav-links]");
      if (!root || !btn || !links) return;

      const close = () => {
        root.classList.remove("nav-open");
        btn.setAttribute("aria-expanded", "false");
      };
      const toggle = () => {
        const open = root.classList.toggle("nav-open");
        btn.setAttribute("aria-expanded", open ? "true" : "false");
      };

      btn.addEventListener("click", toggle);
      links.addEventListener("click", (e) => {
        if (e.target.tagName === "A") close();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") close();
      });
    })();
  });
</script>

</body>
</html>
